version: '3.8'

services:
  # --- DMZ ZONE ---
  nginx:
    image: nginx:1.21
    container_name: nginx_load_balancer
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    networks:
      dmz_net:
        ipv4_address: 172.20.0.10
    extra_hosts:
      - "api-gateway:172.20.0.5" # Points to Firewall
    depends_on:
      - firewall
    restart: unless-stopped

  # --- FIREWALL ---
  firewall:
    image: alpine:latest
    container_name: internal_firewall
    cap_add:
      - NET_ADMIN
    volumes:
      - ./firewall/firewall.sh:/firewall.sh
    command: /bin/sh -c "apk add --no-cache iptables && chmod +x /firewall.sh && /firewall.sh && tail -f /dev/null"
    networks:
      dmz_net:
        ipv4_address: 172.20.0.5
      internal_net:
        ipv4_address: 172.21.0.5
    ports:
      - "9876:9876/udp" # Expose UDP for Microcontrollers via Firewall
    sysctls:
      - net.ipv4.ip_forward=1

  # --- INTERNAL ZONE ---
  wind-internal-bus:
    image: rabbitmq:3.12-management
    container_name: wind-internal-bus
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      internal_net:
        ipv4_address: 172.21.0.12
    volumes:
      - wind_rabbitmq_data:/var/lib/rabbitmq/
    environment:
      - RABBITMQ_DEFAULT_USER=winduser
      - RABBITMQ_DEFAULT_PASS=windpass
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  service-discovery:
    build:
      context: ../
      dockerfile: Dockerfile
      target: service-discovery
    container_name: service-discovery
    networks:
      internal_net:
        ipv4_address: 172.21.0.11
    environment:
      - SERVICE_DISCOVERY_URL=http://service-discovery:7000
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7000/health"]
      interval: 10s 
      timeout: 5s
      retries: 5
      start_period: 10s

  api-gateway:
    build:
      context: ../
      dockerfile: Dockerfile
      target: api-gateway
    container_name: api-gateway
    networks:
      internal_net:
        ipv4_address: 172.21.0.10
    environment:
      - SERVICE_DISCOVERY_URL=http://service-discovery:7000
    restart: on-failure
    depends_on:
      service-discovery:
        condition: service_healthy

  application-server:
    build:
      context: ../
      dockerfile: Dockerfile
      target: application-server
    container_name: application-server
    networks:
      internal_net:
        ipv4_address: 172.21.0.13
    volumes:
      - ./database_backup:/app/database
    depends_on:
      wind-internal-bus:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
    restart: on-failure

  weather-station:
    build:
      context: ../
      dockerfile: Dockerfile
      target: weather-station
    container_name: weather-station
    cap_add:
      - NET_ADMIN
    entrypoint: /bin/sh -c "ip route del default || true; ip route add default via 172.21.0.5; java -jar /app/app.jar"
    networks:
      internal_net:
        ipv4_address: 172.21.0.14
    environment:
      - RABBITMQ_HOST=wind-internal-bus
      - SERVICE_DISCOVERY_URL=http://service-discovery:7000
      - EGRESS_HOST=172.21.0.5
      - EGRESS_PORT=9877
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      wind-internal-bus:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
    restart: on-failure

networks:
  dmz_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  internal_net:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/24

volumes:
  wind_rabbitmq_data:
